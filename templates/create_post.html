<!DOCTYPE html>
<html>
<head>
    <title>Create Post</title>
    <script src="{{ url_for('static', filename='tinymce/tinymce.min.js') }}"></script>
    <!-- Note: Google Photo Picker API removed due to 2024 restrictions -->
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8fafc;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #1e293b;
            margin-bottom: 30px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 15px;
        }
        
        label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin: 20px 0 8px 0;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .image-upload-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            background-color: #f9fafb;
            text-align: center;
            transition: all 0.3s;
        }
        
        .image-upload-section:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        
        .image-upload-section.dragover {
            border-color: #3b82f6;
            background-color: #dbeafe;
            transform: scale(1.02);
        }
        
        .upload-button {
            background-color: #3b82f6;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .upload-button:hover {
            background-color: #2563eb;
        }
        
        .insert-images-btn {
            background-color: #059669;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            margin: 10px 5px;
            transition: background-color 0.2s;
        }
        
        .insert-images-btn:hover {
            background-color: #047857;
        }
        
        .insert-images-btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        
        #file-input {
            display: none;
        }
        
        .preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .preview-item {
            position: relative;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.2s;
        }
        
        .preview-item:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .preview-item img, .preview-item video {
            width: 100%;
            height: 80px;
            object-fit: cover;
        }
        
        .preview-item .media-type {
            position: absolute;
            top: 5px;
            left: 5px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .preview-item .filename {
            padding: 8px;
            font-size: 12px;
            color: #6b7280;
            background: #f9fafb;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .preview-item .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
            align-items: center;
        }
        
        button {
            padding: 12px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2563eb;
        }
        
        
        .flash-messages {
            margin-bottom: 20px;
        }
        
        .flash-messages ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .flash-messages li {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 10px;
            background-color: #dcfce7;
            color: #166534;
            border-left: 4px solid #22c55e;
        }
        
        .loading {
            display: none;
            color: #6b7280;
            font-style: italic;
        }
        
        #editor {
            margin: 20px 0;
            width: 100%;
            box-sizing: border-box;
        }
        
        /* Ensure TinyMCE iframe takes full width */
        .tox-tinymce {
            width: 100% !important;
        }
        
        .upload-info {
            color: #6b7280;
            font-size: 14px;
            margin-top: 10px;
        }

        .resize-settings {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-size: 14px;
        }

        .resize-settings label {
            margin: 5px 15px 5px 0;
            font-weight: normal;
            display: inline-block;
        }

        .resize-settings input[type="number"] {
            width: 80px;
            padding: 4px 8px;
            margin-left: 5px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
        }

        .resize-settings input[type="range"] {
            width: 100px;
            margin-left: 5px;
        }

        .button-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .google-photos-btn {
            background: linear-gradient(135deg, #ea4335 0%, #fbbc05 25%, #34a853 50%, #4285f4 100%);
        }

        .google-photos-btn:hover {
            background: linear-gradient(135deg, #d33b2c 0%, #f9ab00 25%, #2d8a43 50%, #3367d6 100%);
        }

        /* Google Photos Picker Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 2% auto;
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 1200px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }

        .modal-header h2 {
            margin: 0;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close {
            color: #94a3b8;
            float: right;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }

        .close:hover {
            color: #ef4444;
        }

        .photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .photo-item {
            position: relative;
            border: 3px solid transparent;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
        }

        .photo-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .photo-item.selected {
            border-color: #3b82f6;
            transform: scale(0.95);
        }

        .photo-item img {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }

        .photo-checkbox {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #d1d5db;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .photo-item.selected .photo-checkbox {
            background: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }

        .photo-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
            color: white;
            padding: 15px 10px 8px;
            font-size: 12px;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e2e8f0;
        }

        .selection-count {
            color: #6b7280;
            font-weight: 500;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Create a New Post</h1>
        
        <div class="flash-messages">
            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                <ul>
                  {% for category, message in messages %}
                    <li><strong>{{ category }}:</strong> {{ message }}</li>
                  {% endfor %}
                </ul>
              {% endif %}
            {% endwith %}
        </div>

        <form method="POST" enctype="multipart/form-data">
            <div style="display: flex; gap: 15px; align-items: end; margin-bottom: 20px;">
                <div style="flex: 1;">
                    <label for="title">Post Title</label>
                    <input type="text" name="title" id="title" required>
                </div>
                <div>
                    <button type="submit" class="btn-primary">‚ú® Create Post</button>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <label for="tags">Tags</label>
                {% if available_tags %}
                    <input type="text" name="tags" id="tags" placeholder="Available tags: {{ ', '.join(available_tags) }}{% if 'major' not in available_tags %}, major{% endif %}">
                {% else %}
                    <input type="text" name="tags" id="tags" placeholder="Enter tags separated by commas (e.g., major, photos, news)">
                {% endif %}
                <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                    üí° Use "major" tag to send notifications to all users (otherwise only users with "All Posts" preference get notified)
                    {% if available_tags %}
                        <br>üè∑Ô∏è Filter tags: <strong>{{ ', '.join(available_tags) }}</strong>
                    {% endif %}
                </div>
            </div>

            <label for="editor">Content</label>
            <textarea id="editor" name="content"></textarea>

            <!-- Image Upload Section - Moved to bottom -->
            <div class="image-upload-section" id="drop-zone">
                <div style="margin-bottom: 15px;">
                    <h3 style="margin: 0 0 10px 0; color: #374151;">üì∏üé¨ Add Images & Videos to Your Post</h3>
                    <p style="color: #6b7280; margin: 0;">Upload from your device or select from Google Photos</p>
                </div>
                
                <!-- Image Resize Settings -->
                <div class="resize-settings">
                    <strong>üé® Image Resize Settings:</strong><br>
                    <label>Max Width: <input type="number" id="maxWidth" value="1200" min="200" max="2000"> px</label>
                    <label>Max Height: <input type="number" id="maxHeight" value="800" min="200" max="2000"> px</label>
                    <label>Quality: <input type="range" id="quality" min="0.1" max="1" step="0.1" value="0.8"> <span id="qualityValue">80%</span></label>
                    <br><small style="color: #6b7280;">Images will be automatically resized to optimize file size and loading speed</small>
                </div>
                
                <input type="file" id="file-input" multiple accept="image/*,video/*">
                <div class="button-row">
                    <button type="button" class="upload-button" onclick="document.getElementById('file-input').click()">
                        üìÅ Choose from Device
                    </button>
                    <button type="button" class="upload-button google-photos-btn" onclick="openGooglePhotosPicker()">
                        üì∑ Browse Google Photos
                    </button>
                </div>
                
                <div class="upload-info">
                    Images: JPG, PNG, GIF, WebP ‚Ä¢ Videos: MP4, MOV, AVI, WebM ‚Ä¢ Max 100MB total
                </div>
                
                <div style="margin: 15px 0;">
                    <button type="button" class="insert-images-btn" id="insert-all-btn" onclick="insertAllMedia()" disabled>
                        ‚ú® Insert All Media
                    </button>
                    <button type="button" class="insert-images-btn" onclick="clearAllMedia()">
                        üóëÔ∏è Clear All
                    </button>
                    <span class="loading" id="loading">Processing and uploading files...</span>
                </div>
            </div>

            <!-- Preview Container -->
            <div class="preview-container" id="preview-container"></div>

        </form>
    </div>

    <!-- Google Photos Picker Modal -->
    <div id="googlePhotosModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì∑ Select from Google Photos</h2>
                <span class="close">&times;</span>
            </div>
            
            <div class="loading-spinner" id="photosLoading">
                <div class="spinner"></div>
                <p>Loading your Google Photos...</p>
            </div>
            
            <div class="photos-grid" id="photosGrid"></div>
            
            <div class="modal-footer">
                <div class="selection-count">
                    <span id="selectedCount">0</span> media selected
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-primary" onclick="closeGooglePhotosModal()">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="importSelectedPhotos()" id="importBtn" disabled>
                        ‚ú® Import Selected Media
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let uploadedMedia = [];
        
        // Update quality display
        document.getElementById('quality').addEventListener('input', function() {
            document.getElementById('qualityValue').textContent = Math.round(this.value * 100) + '%';
        });
        
        // Image resizing function
        function resizeImage(file, maxWidth = 1200, maxHeight = 800, quality = 0.8) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // Calculate new dimensions while maintaining aspect ratio
                    let { width, height } = img;
                    
                    // Calculate scaling factor
                    const scaleX = maxWidth / width;
                    const scaleY = maxHeight / height;
                    const scale = Math.min(scaleX, scaleY, 1); // Don't upscale
                    
                    const newWidth = Math.floor(width * scale);
                    const newHeight = Math.floor(height * scale);
                    
                    canvas.width = newWidth;
                    canvas.height = newHeight;
                    
                    // Enable image smoothing for better quality
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    
                    // Draw and resize
                    ctx.drawImage(img, 0, 0, newWidth, newHeight);
                    
                    // Convert to blob with specified quality
                    canvas.toBlob((blob) => {
                        // Create a new File object with the original name
                        const resizedFile = new File([blob], file.name, {
                            type: 'image/jpeg',
                            lastModified: Date.now()
                        });
                        resolve(resizedFile);
                    }, 'image/jpeg', quality);
                };
                
                img.onerror = function() {
                    console.error('Error loading image for resize');
                    resolve(file); // Return original file if resize fails
                };
                
                img.src = URL.createObjectURL(file);
            });
        }

        // Get file size in human readable format
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // TinyMCE Configuration
        tinymce.init({
            selector: '#editor',
            width: '100%',
            plugins: 'autoresize image media link code lists textcolor colorpicker hr table paste',
            autoresize_min_height: 400,
            autoresize_max_height: 2000,
            toolbar: 'undo redo | styles | bold italic underline strikethrough | ' +
                     'forecolor backcolor | alignleft aligncenter alignright alignjustify | ' +
                     'bullist numlist outdent indent | image media link table | hr | code',
            images_upload_url: "{{ url_for('upload_media') }}",
            automatic_uploads: true,
            images_upload_credentials: true,
            media_live_embeds: true,
            license_key: 'gpl',
            file_picker_types: 'image media',
            images_reuse_filename: true,
            convert_urls: false,
            relative_urls: false,
            remove_script_host: false,
            paste_data_images: true,
            content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; font-size: 16px; line-height: 1.6; } img { max-width: 60%; height: auto; border-radius: 8px; margin: 10px 0; box-shadow: 0 4px 12px rgba(0,0,0,0.1); cursor: pointer; } video { max-width: 100%; height: auto; border-radius: 8px; margin: 10px 0; }',
            images_upload_handler: function (blobInfo, success, failure) {
                var xhr = new XMLHttpRequest();
                xhr.open('POST', "{{ url_for('upload_media') }}");
                xhr.onload = function() {
                    if (xhr.status != 200) {
                        failure('HTTP Error: ' + xhr.status);
                        return;
                    }
                    var json;
                    try {
                        json = JSON.parse(xhr.responseText);
                    } catch (e) {
                        failure('Could not parse JSON: ' + xhr.responseText);
                        return;
                    }
                    if (!json || typeof json.location != 'string') {
                        failure('Invalid JSON: ' + xhr.responseText);
                        return;
                    }
                    success(json.location);
                };
                var formData = new FormData();
                formData.append('file', blobInfo.blob(), blobInfo.filename());
                xhr.send(formData);
            }
        });

        // File input change handler
        document.getElementById('file-input').addEventListener('change', function(e) {
            handleFiles(e.target.files);
        });

        // Drag and drop handlers
        const dropZone = document.getElementById('drop-zone');

        dropZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', function(e) {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        // Handle file selection with resizing
        async function handleFiles(files) {
            if (files.length === 0) return;

            console.log('Selected files:', Array.from(files).map(f => f.name));
            document.getElementById('loading').style.display = 'inline';

            // Get resize settings
            const maxWidth = parseInt(document.getElementById('maxWidth').value);
            const maxHeight = parseInt(document.getElementById('maxHeight').value);
            const quality = parseFloat(document.getElementById('quality').value);

            const formData = new FormData();
            let totalOriginalSize = 0;
            let totalProcessedSize = 0;
            
            for (let file of files) {
                totalOriginalSize += file.size;
                
                if (file.type.startsWith('image/') && !file.type.includes('gif')) {
                    // Resize image (skip GIFs to preserve animation)
                    console.log(`Resizing image: ${file.name} (${formatFileSize(file.size)})`);
                    const resizedFile = await resizeImage(file, maxWidth, maxHeight, quality);
                    totalProcessedSize += resizedFile.size;
                    formData.append('media', resizedFile, file.name);
                    console.log(`Resized to: ${formatFileSize(resizedFile.size)} (${Math.round((1 - resizedFile.size/file.size) * 100)}% reduction)`);
                } else {
                    // Keep videos and GIFs as-is
                    totalProcessedSize += file.size;
                    formData.append('media', file);
                    console.log(`Added ${file.type.startsWith('video/') ? 'video' : 'file'}: ${file.name} (${formatFileSize(file.size)})`);
                }
            }

            try {
                const uploadUrl = '{{ url_for("upload_multiple_media") }}';
                console.log('Sending request to:', uploadUrl);
                console.log(`Total size reduction: ${formatFileSize(totalOriginalSize)} ‚Üí ${formatFileSize(totalProcessedSize)} (${Math.round((1 - totalProcessedSize/totalOriginalSize) * 100)}% smaller)`);
                
                const response = await fetch(uploadUrl, {
                    method: 'POST',
                    body: formData
                });

                console.log('Response status:', response.status);

                // Get response text first to debug
                const responseText = await response.text();
                console.log('Raw response:', responseText);

                // Try to parse as JSON
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('JSON parse error:', parseError);
                    console.error('Response text:', responseText);
                    throw new Error('Server returned invalid JSON. Check the server console for errors.');
                }

                if (result.success) {
                    result.media.forEach(media => {
                        uploadedMedia.push(media);
                        addMediaPreview(media);
                    });
                    
                    updateInsertButton();
                    const savings = totalOriginalSize > totalProcessedSize ? 
                        ` (${formatFileSize(totalOriginalSize - totalProcessedSize)} saved!)` : '';
                    alert(`Successfully uploaded ${result.count} file(s)!${savings}`);
                } else {
                    alert('Upload failed: ' + result.error);
                }
            } catch (error) {
                console.error('Upload error:', error);
                alert('Upload failed: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
                // Clear the file input
                document.getElementById('file-input').value = '';
            }
        }

        // Add media preview
        function addMediaPreview(media) {
            const container = document.getElementById('preview-container');
            
            const previewItem = document.createElement('div');
            previewItem.className = 'preview-item';
            previewItem.dataset.filename = media.filename;
            
            let mediaElement;
            if (media.type === 'image') {
                mediaElement = `<img src="${media.url}" alt="${media.original_name}">`;
            } else {
                mediaElement = `<video src="${media.url}" muted></video>`;
            }
            
            previewItem.innerHTML = `
                ${mediaElement}
                <div class="media-type">${media.type.toUpperCase()}</div>
                <div class="filename">${media.original_name}</div>
                <button class="remove-btn" onclick="removeMedia('${media.filename}')" type="button">√ó</button>
            `;
            
            // Add click handler to insert individual media
            previewItem.addEventListener('dblclick', function() {
                insertSingleMedia(media);
            });
            
            container.appendChild(previewItem);
        }

        // Remove media
        function removeMedia(filename) {
            uploadedMedia = uploadedMedia.filter(media => media.filename !== filename);
            const previewItem = document.querySelector(`[data-filename="${filename}"]`);
            if (previewItem) {
                previewItem.remove();
            }
            updateInsertButton();
        }

        // Update insert button state
        function updateInsertButton() {
            const insertBtn = document.getElementById('insert-all-btn');
            insertBtn.disabled = uploadedMedia.length === 0;
            insertBtn.textContent = uploadedMedia.length > 0 
                ? `‚ú® Insert All Media (${uploadedMedia.length})` 
                : '‚ú® Insert All Media';
        }

        // Insert single media into editor
        function insertSingleMedia(media) {
            let mediaHtml;
            if (media.type === 'image') {
                mediaHtml = `<img src="${media.url}" alt="${media.original_name}" style="max-width: 60%; height: auto; margin: 10px 0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); cursor: pointer;" />`;
            } else {
                mediaHtml = `<video controls style="max-width: 100%; height: auto; margin: 10px 0; border-radius: 8px;">
                    <source src="${media.url}" type="video/${media.extension}">
                    Your browser does not support the video tag.
                </video>`;
            }
            tinymce.get('editor').insertContent(mediaHtml);
        }

        // Insert all media into editor
        function insertAllMedia() {
            if (uploadedMedia.length === 0) return;
            
            let htmlContent = '';
            uploadedMedia.forEach(media => {
                if (media.type === 'image') {
                    htmlContent += `<img src="${media.url}" alt="${media.original_name}" style="max-width: 60%; height: auto; margin: 10px 0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); cursor: pointer;" /><p></p>`;
                } else {
                    htmlContent += `<video controls style="max-width: 100%; height: auto; margin: 10px 0; border-radius: 8px;">
                        <source src="${media.url}" type="video/${media.extension}">
                        Your browser does not support the video tag.
                    </video><p></p>`;
                }
            });
            
            tinymce.get('editor').insertContent(htmlContent);
            
            // Clear uploaded media after inserting
            clearAllMedia();
        }

        // Clear all media
        function clearAllMedia() {
            uploadedMedia = [];
            document.getElementById('preview-container').innerHTML = '';
            updateInsertButton();
        }

        // Initialize
        updateInsertButton();
        
        // Google Photos Picker API (2024) - Proper implementation
        let currentPickerSession = null;
        let pollingInterval = null;
        let isDownloading = false;
        let sessionCompleted = false;
        
        async function openGooglePhotosPicker() {
            console.log('Opening Google Photos Picker...');
            
            // Clear any existing polling to prevent duplicates
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
            
            // Reset flags
            isDownloading = false;
            sessionCompleted = false;
            
            const modal = document.getElementById('googlePhotosModal');
            const loading = document.getElementById('photosLoading');
            const grid = document.getElementById('photosGrid');
            
            modal.style.display = 'block';
            loading.style.display = 'block';
            grid.innerHTML = '';
            
            try {
                // Step 1: Create picker session
                console.log('Creating picker session...');
                const response = await fetch('{{ url_for("create_picker_session_endpoint") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const sessionData = await response.json();
                
                if (!sessionData.success) {
                    // Check if this is an authentication requirement (not an error)
                    if (sessionData.auth_required && sessionData.auth_url) {
                        console.log('Authentication required, redirecting to:', sessionData.auth_url);
                        
                        loading.style.display = 'none';
                        grid.innerHTML = `
                            <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #6b7280;">
                                <h3 style="color: #1e293b; margin-bottom: 20px;">üîê Google Photos Authentication Required</h3>
                                
                                <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border: 2px solid #3b82f6; border-radius: 12px; padding: 25px; margin: 20px 0;">
                                    <h4 style="margin: 0 0 15px 0; color: #1e40af;">üì∑ Authenticate with Google Photos</h4>
                                    <p style="margin: 10px 0; color: #1e40af; line-height: 1.6;">
                                        To import photos from Google Photos, you need to authenticate first.
                                        Click the button below to securely connect your Google account.
                                    </p>
                                </div>
                                
                                <div style="margin: 25px 0;">
                                    <a href="${sessionData.auth_url}" target="_blank" 
                                       style="display: inline-block; background: #4f46e5; color: white; text-decoration: none; 
                                              padding: 12px 24px; border-radius: 8px; font-weight: 600; font-size: 16px;
                                              box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3); 
                                              transition: all 0.2s; border: none;">
                                        üöÄ Authenticate Google Photos
                                    </a>
                                </div>
                                
                                <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin: 20px 0;">
                                    <h4 style="margin: 0 0 10px 0; color: #374151;">üìã Instructions:</h4>
                                    <ol style="text-align: left; margin: 10px 0; padding-left: 20px; color: #4b5563; line-height: 1.6;">
                                        <li><strong>Click "Authenticate Google Photos"</strong> above</li>
                                        <li><strong>Sign in</strong> with your Google account</li>
                                        <li><strong>Grant permissions</strong> for Google Photos access</li>
                                        <li><strong>Return to this page</strong> and try "Browse Google Photos" again</li>
                                    </ol>
                                </div>
                                
                                <button onclick="closeGooglePhotosModal()" class="btn btn-secondary" 
                                        style="background: #6b7280; color: white; border: none; padding: 10px 20px; 
                                               border-radius: 6px; cursor: pointer; margin-top: 15px;">
                                    Close
                                </button>
                            </div>
                        `;
                        return; // Exit early - not an error, just needs authentication
                    }
                    
                    // If not auth required, then it's a real error
                    throw new Error(sessionData.error || 'Failed to create picker session');
                }
                
                currentPickerSession = sessionData.sessionId;
                const pickerUri = sessionData.pickerUri;
                
                console.log('Session created:', currentPickerSession);
                console.log('Picker URI:', pickerUri);
                
                // Step 2: Automatically open Google Photos picker
                window.open(pickerUri, '_blank');
                
                // Step 3: Show interface and start polling automatically
                loading.style.display = 'none';
                startPolling();
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #6b7280;">
                        <h3 style="color: #1e293b; margin-bottom: 20px;">üì∑ Google Photos Picker</h3>
                        
                        <div style="background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); border: 2px solid #22c55e; border-radius: 12px; padding: 25px; margin: 20px 0;">
                            <h4 style="margin: 0 0 15px 0; color: #166534;">‚úÖ Google Photos Picker Opened!</h4>
                            <p style="margin: 10px 0; color: #166534; line-height: 1.6;">
                                Google Photos should have opened in a new tab. Select your photos there,
                                then come back to this page and we'll automatically detect your selection 
                                and import the photos.
                            </p>
                        </div>
                        
                        <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin: 20px 0;">
                            <h4 style="margin: 0 0 10px 0; color: #374151;">üìã Instructions:</h4>
                            <ol style="text-align: left; margin: 10px 0; padding-left: 20px; color: #4b5563; line-height: 1.6;">
                                <li><strong>Switch to the Google Photos tab</strong> that just opened</li>
                                <li><strong>Select photos/videos</strong> you want to add to your post</li>
                                <li><strong>Confirm your selection</strong> in Google Photos</li>
                                <li><strong>Return to this page</strong> - we'll automatically import your selection!</li>
                            </ol>
                        </div>
                        
                        <div style="display: flex; gap: 15px; justify-content: center; margin: 20px 0; flex-wrap: wrap;">
                            <button onclick="cancelPickerSession()" class="btn btn-primary">
                                ‚ùå Cancel & Close
                            </button>
                        </div>
                        
                        <div id="polling-status" style="margin-top: 20px;">
                            <div style="background: #fffbeb; border: 1px solid #f59e0b; border-radius: 8px; padding: 15px;">
                                <p style="margin: 0; color: #92400e; font-weight: 500;">
                                    ‚è≥ Waiting for your photo selection... 
                                    <span style="font-weight: normal;">Please complete your selection in the Google Photos tab.</span>
                                </p>
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error creating picker session:', error);
                loading.style.display = 'none';
                
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #6b7280;">
                        <h3 style="color: #dc2626;">‚ùå Error</h3>
                        <p style="margin: 15px 0; color: #dc2626;">
                            Failed to create Google Photos picker session: ${error.message}
                        </p>
                        <div style="background: #fef2f2; border: 1px solid #fca5a5; border-radius: 8px; padding: 15px; margin: 20px 0; text-align: left;">
                            <h4 style="margin: 0 0 10px 0; color: #dc2626;">Possible Solutions:</h4>
                            <ul style="margin: 0; padding-left: 20px; color: #dc2626;">
                                <li>Check your Google Photos API authentication</li>
                                <li>Verify the Google Photos Library API is enabled</li>
                                <li>Make sure you have proper OAuth permissions</li>
                            </ul>
                        </div>
                        <button onclick="closeGooglePhotosModal()" class="btn btn-primary">
                            OK
                        </button>
                    </div>
                `;
            }
        }
        
        function startPolling() {
            console.log('Starting polling for session:', currentPickerSession);
            
            // Show polling status
            const statusDiv = document.getElementById('polling-status');
            if (statusDiv) {
                statusDiv.style.display = 'block';
            }
            
            // Start polling every 3 seconds
            pollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(`{{ url_for("poll_picker_session_endpoint", session_id="") }}${currentPickerSession}`);
                    const pollData = await response.json();
                    
                    if (pollData.success && pollData.completed && !sessionCompleted) {
                        sessionCompleted = true; // Mark session as completed immediately
                        clearInterval(pollingInterval);
                        pollingInterval = null;
                        
                        if (pollData.cancelled) {
                            console.log('User cancelled photo selection');
                            showPickerResult('Cancelled', 'You cancelled the photo selection.', 'info');
                        } else if (pollData.selectedItems && pollData.selectedItems.length > 0) {
                            console.log('Photos selected:', pollData.selectedItems);
                            await downloadSelectedPhotos(pollData.selectedItems);
                        } else {
                            console.log('No photos selected');
                            showPickerResult('No Selection', 'No photos were selected.', 'info');
                        }
                    } else if (pollData.success) {
                        console.log('Still waiting for selection, state:', pollData.state);
                    } else {
                        throw new Error(pollData.error || 'Polling failed');
                    }
                    
                } catch (error) {
                    console.error('Polling error:', error);
                    clearInterval(pollingInterval);
                    showPickerResult('Error', `Polling failed: ${error.message}`, 'error');
                }
            }, 3000); // Poll every 3 seconds
        }
        
        async function downloadSelectedPhotos(selectedItems) {
            try {
                if (isDownloading) {
                    console.log('Download already in progress, skipping...');
                    return;
                }
                
                isDownloading = true;
                console.log('Downloading selected media...');
                
                // Show download progress
                const grid = document.getElementById('photosGrid');
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #6b7280;">
                        <h3 style="color: #1e293b;">‚è≥ Downloading Media...</h3>
                        <p>Processing ${selectedItems.length} selected media item(s) from Google Photos...</p>
                        <div style="margin: 20px 0;">
                            <div style="width: 100%; background: #e5e7eb; border-radius: 10px; height: 8px; overflow: hidden;">
                                <div style="width: 0%; background: linear-gradient(90deg, #3b82f6, #1d4ed8); height: 100%; border-radius: 10px; animation: progress 3s ease-in-out infinite;" id="progress-bar"></div>
                            </div>
                        </div>
                    </div>
                `;
                
                const response = await fetch('{{ url_for("download_selected_media") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        selectedItems: selectedItems
                    })
                });
                
                const downloadData = await response.json();
                
                if (downloadData.success) {
                    console.log('Successfully downloaded media:', downloadData.media);
                    
                    // Add downloaded media to the media preview
                    downloadData.media.forEach(media => {
                        uploadedMedia.push(media);
                        addMediaPreview(media);
                    });
                    
                    updateInsertButton();
                    closeGooglePhotosModal();
                    
                    // Success - no popup needed, photos are already visible in preview
                    
                } else {
                    throw new Error(downloadData.error || 'Download failed');
                }
                
            } catch (error) {
                console.error('Download error:', error);
                showPickerResult('Download Error', `Failed to download media: ${error.message}`, 'error');
            } finally {
                isDownloading = false;
            }
        }
        
        function showPickerResult(title, message, type) {
            const grid = document.getElementById('photosGrid');
            const bgColor = type === 'error' ? '#fef2f2' : type === 'info' ? '#f0f9ff' : '#f0fdf4';
            const borderColor = type === 'error' ? '#fca5a5' : type === 'info' ? '#93c5fd' : '#86efac';
            const textColor = type === 'error' ? '#dc2626' : type === 'info' ? '#2563eb' : '#16a34a';
            
            grid.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #6b7280;">
                    <h3 style="color: ${textColor};">${title}</h3>
                    <div style="background: ${bgColor}; border: 1px solid ${borderColor}; border-radius: 8px; padding: 20px; margin: 20px 0;">
                        <p style="margin: 0; color: ${textColor};">${message}</p>
                    </div>
                    <button onclick="closeGooglePhotosModal()" class="btn btn-primary">
                        OK
                    </button>
                </div>
            `;
        }
        
        function cancelPickerSession() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
            currentPickerSession = null;
            closeGooglePhotosModal();
        }
        
        function displayGooglePhotos(photos) {
            const grid = document.getElementById('photosGrid');
            
            if (!photos || photos.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #6b7280;">
                        <h3>No Photos Found</h3>
                        <p>No photos were found in your Google Photos library.</p>
                    </div>
                `;
                return;
            }
            
            photos.forEach(photo => {
                const photoElement = document.createElement('div');
                photoElement.className = 'photo-item';
                photoElement.dataset.photoId = photo.id;
                
                // Format creation time
                const createdDate = photo.mediaMetadata && photo.mediaMetadata.creationTime 
                    ? new Date(photo.mediaMetadata.creationTime).toLocaleDateString()
                    : 'Unknown date';
                
                // Check if it's a video
                const isVideo = photo.mediaMetadata && photo.mediaMetadata.video;
                const mediaIcon = isVideo ? 'üé•' : 'üì∏';
                
                photoElement.innerHTML = `
                    <img src="${photo.baseUrl}=w300-h300-c" alt="Google Photo" loading="lazy">
                    <div class="photo-checkbox">
                        <span style="display: none;">‚úì</span>
                    </div>
                    <div class="photo-info">
                        ${mediaIcon} ${createdDate}
                    </div>
                `;
                
                photoElement.addEventListener('click', () => togglePhotoSelection(photo, photoElement));
                grid.appendChild(photoElement);
            });
        }
        
        function togglePhotoSelection(photo, element) {
            const isSelected = element.classList.contains('selected');
            
            if (isSelected) {
                element.classList.remove('selected');
                element.querySelector('.photo-checkbox span').style.display = 'none';
                selectedPhotos = selectedPhotos.filter(p => p.id !== photo.id);
            } else {
                element.classList.add('selected');
                element.querySelector('.photo-checkbox span').style.display = 'block';
                selectedPhotos.push(photo);
            }
            
            updateSelectionCount();
        }
        
        function updateSelectionCount() {
            const countElement = document.getElementById('selectedCount');
            const importBtn = document.getElementById('importBtn');
            
            countElement.textContent = selectedPhotos.length;
            importBtn.disabled = selectedPhotos.length === 0;
            
            if (selectedPhotos.length > 0) {
                importBtn.textContent = `‚ú® Import ${selectedPhotos.length} Media Item${selectedPhotos.length > 1 ? 's' : ''}`;
            } else {
                importBtn.textContent = '‚ú® Import Selected Media';
            }
        }
        
        // Note: This function is no longer used - Google Photos import is handled by download_selected_media
        // Keeping for reference only
        async function importSelectedPhotos() {
            if (selectedPhotos.length === 0) return;
            
            const importBtn = document.getElementById('importBtn');
            const originalText = importBtn.textContent;
            
            importBtn.disabled = true;
            importBtn.textContent = '‚è≥ Importing...';
            
            try {
                // This endpoint no longer exists - use download_selected_media instead
                const response = await fetch('#', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        photos: selectedPhotos.map(p => ({
                            id: p.id,
                            baseUrl: p.baseUrl,
                            filename: p.filename,
                            mediaMetadata: p.mediaMetadata
                        }))
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Add imported media to the media preview
                    result.media.forEach(media => {
                        uploadedMedia.push(media);
                        addMediaPreview(media);
                    });
                    
                    updateInsertButton();
                    closeGooglePhotosModal();
                    
                    const savings = result.totalOriginalSize > result.totalProcessedSize ? 
                        ` (${formatFileSize(result.totalOriginalSize - result.totalProcessedSize)} saved!)` : '';
                    alert(`Successfully imported ${result.count} media item${result.count > 1 ? 's' : ''} from Google Photos!${savings}`);
                } else {
                    alert('Import failed: ' + result.error);
                }
            } catch (error) {
                console.error('Import error:', error);
                alert('Import failed: ' + error.message);
            } finally {
                importBtn.disabled = false;
                importBtn.textContent = originalText;
            }
        }
        
        function closeGooglePhotosModal() {
            document.getElementById('googlePhotosModal').style.display = 'none';
            selectedPhotos = [];
            updateSelectionCount();
        }
        
        // Modal event handlers
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('googlePhotosModal');
            const closeBtn = modal.querySelector('.close');
            
            closeBtn.addEventListener('click', closeGooglePhotosModal);
            
            // Close modal when clicking outside of it
            window.addEventListener('click', function(event) {
                if (event.target === modal) {
                    closeGooglePhotosModal();
                }
            });
        });
    </script>
</body>
</html>